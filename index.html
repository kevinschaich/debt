<!DOCTYPE html>
<html>
<head>
    <title>3300 - P1</title>
    <style>
        #xaxis .domain {
            fill:none;
        }
        body {
            font-family: Roboto Slab;
            fill: #E0E0E0;
            font-size: 12pt;
            background: #2B303B;
        }
        .x.axis {
            font-size: 10pt;
        }
        .sub.axis {
            font-size: 10pt;
            fill: #878787;
            font-family: Roboto;
            font-size: 10pt;
        }
        .axis path {
            fill: none;
        }
        rect {
            rx: 3;
            ry: 3;
        }
        .arc {
            fill: none;
            stroke: #E0E0E0;
            opacity: .6;
        }

    </style>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script>
            // First, checks if it isn't implemented yet.
            if (!String.prototype.format) {
              String.prototype.format = function() {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function(match, number) {
                  return typeof args[number] != 'undefined'
                  ? args[number]
                  : match
                  ;
              });
            };
        }
    </script>

</head>
<body>
    <div id="wrapper">
    </div>
    <div id="padding">
    </div>
    <script>
        d3.csv("data.csv", function(data) {

            // console.log(data);

            ////////////////////////////////////////////////////////////////////
            // CONSTANTS ///////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            // bars
            var BarHeight = 50;
            var BarSpacing = 5;

            // padding / spacing
            var paddingLeft = 300;
            var paddingRight = paddingLeft;
            var paddingTop = BarHeight;
            var paddingBottom = 0;
            var graphSpacing = BarHeight * 2;

            // titles
            var titleOffset = -10;
            var subtitleOffset = 10;

            // scales / colors
            var scales = [1000, 1000000, 1000000000, 1000000000000];
            var colors = ['#bf616a', '#d08770', '#ebcb8b', '#a3be8c', '#796895', '#5C7DA4', '#b48ead', '#ab7967', '#537776'];
            var categories = [];
            for (var i = 0; i < data.length; i++) {
                if (categories.indexOf(data[i]['category']) === -1)
                    categories.push(data[i]['category']);
            }

            // console.log(categories.length);

            // canvas geometry
            var width = 1440;
            var height = data.length * (BarHeight + BarSpacing) + (graphSpacing * scales.length);
            var cur_height = 0;
            var canvas = d3.select('#wrapper')
            .append('svg')
            .attr("id","main")
            .attr({'width': width,'height': height});

            ////////////////////////////////////////////////////////////////////
            // DRAW INSETS /////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            function drawGraph(data, xmax) {

                ////////////////////////////////////////////////////////////////
                // CONSTANTS ///////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                var xmin = 0;
                var height = data.length * (BarHeight + BarSpacing);

                console.log("height is" + height);
                var canvas = d3.select('#wrapper')
                .select('#main')
                .append("g")
                .attr("transform", "translate(0," + cur_height + ")")
                .attr('class', 'inset');

                var tickVals = [0];
                for (var i = 0; i <= 10; i++) {
                    tickVals.push((xmax / 10) * i);
                }

                ////////////////////////////////////////////////////////////////
                // SCALES //////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                var xscale = d3.scale.linear()
                .domain([xmin, xmax])
                .range([0, width - (paddingLeft + paddingRight)]);

                var yscale = d3.scale.linear()
                .domain([0,data.length - 1])
                .range([height - paddingBottom, paddingTop]);

                ////////////////////////////////////////////////////////////////
                // AXES ////////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                // X axis
                var formatValue = d3.format("$s");
                var xAxis = d3.svg.axis()
                .orient('bottom')
                .scale(xscale)
                .tickValues(tickVals)
                .tickFormat(function(d) {
                    if (width > 1600) {
                        return formatValue(d)
                        .replace('k', ' thousand')
                        .replace('M', ' million')
                        .replace('G', ' billion')
                        .replace('T', ' trillion');
                    }
                    else {
                        return formatValue(d)
                        .replace('k', ' k')
                        .replace('M', ' M')
                        .replace('G', ' B')
                        .replace('T', ' T');
                    }
                });

                // Y axis
                var yAxis = d3.svg.axis()
                .orient('left')
                .scale(yscale)
                .tickFormat(function(d,i){
                    return data[i].name;
                })
                .tickValues(d3.range(data.length));

                var subyAxis = d3.svg.axis()
                .orient('left')
                .scale(yscale)
                .tickFormat(function(d,i){
                    try {
                        return data[i].subtitle;
                    } catch(e) {}
                })
                .tickValues(d3.range(data.length));

                // Create axes
                canvas.append("g")
                .attr("transform", "translate(" + paddingLeft +"," + (height - paddingBottom + (BarHeight / 1.5)) + ")")
                .attr("class", "x axis").call(xAxis);
                canvas.append("g")
                .attr("transform", "translate(" + (paddingLeft - 10) + "," + titleOffset + ")")
                .attr("class", "y axis").call(yAxis);
                canvas.append("g")
                .attr("transform", "translate(" + (paddingLeft - 10) + ","+ subtitleOffset +")")
                .attr("class", "y sub axis").call(subyAxis);

                ////////////////////////////////////////////////////////////////
                // BARS ////////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                var chart = canvas
                .selectAll('rect')
                .data(data)
                .enter()
                .append('rect')
                .datum(function (d){
                    d["height_offset"] = cur_height;
                    return d; })
                .attr('id','bars')
                .attr('height', BarHeight)
                .attr({
                    'x': paddingLeft,
                    'width': function(d) {
                        return xscale(parseFloat(d.price));
                    },
                    'y': function(d,i) {
                        return yscale(i) - (BarHeight / 2);
                    }
                })
                .style({
                    'fill': function(d, i) {
                        var i = categories.indexOf(data[i]['category']);
                        return colors[i];
                    }
                });

                ////////////////////////////////////////////////////////////////
                // SLICES //////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                function slice(xmax, partitions,width){
                    for (var i = 1; i < partitions; i++){
                        canvas.append('rect')
                        .attr({
                            'x': xscale((xmax / partitions) * i) + paddingLeft,
                            'width': width,
                            'y': 0,
                            'height': height + 30
                        })
                        .style('fill', '#2B303B')
                    }
                }
                slice(xmax, 10, 2);
                slice(xmax, 100, 0.5);

                cur_height += height + graphSpacing;
            }

            ////////////////////////////////////////////////////////////////////
            // CREATE PARTITIONS ///////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            var cur = 0;
            var i = 0;

            var partitions = new Array();
            partitions.push(new Array());
            data.forEach(function(point) {
                if (point.price <= scales[cur]) {
                    partitions[i].push(point);
                }
                else {
                    drawGraph(partitions[i].reverse(),scales[cur]);
                    i++;
                    partitions.push(new Array());
                    partitions[i].push(point);
                    cur++;
                }
            });
            drawGraph(partitions[i].reverse(),scales[cur]);

            ////////////////////////////////////////////////////////////////////
            // CREATE LINKS ////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            var linkingGroups = {};
            var bars = d3.selectAll('#bars');
            bars.each(function(i) {
                if (i['Linking']){
                    var offset_h = parseFloat(i["height_offset"]);
                    var y = parseFloat(d3.select(this).attr("y"));
                    if (linkingGroups[i['Linking']]){
                        linkingGroups[i['Linking']].unshift(offset_h+y);
                    }
                    else{
                        linkingGroups[i['Linking']] = [offset_h+y];
                    }
                }
            });

            var curveMax = 800;

            // draw a curve path for each linking
            Object.keys(linkingGroups).forEach(function (d,i){
                pathinfo = [];
                linkingGroups[d].forEach(function (val,i){
                    pathinfo.push(val);
                });

                pathinfo.sort();

                var baryMidpoint = BarHeight/2;

                var xCurveScaling = d3.scale.linear()
                .domain([0, curveMax])
                .range([paddingLeft, width - paddingRight]);

                var widthScaling = d3.scale.linear()
                .domain([0, curveMax])
                .range([5, 40]);

                for (var i=0;i<pathinfo.length-1;i++){
                    var y1 = pathinfo[i]+baryMidpoint;
                    var y2 = pathinfo[i+1]+baryMidpoint;
                    var midy = (y1+y2)/2;
                    var scalingFactor = midy - Math.min(y1,y2);
                    var midx = xCurveScaling(scalingFactor);
                    var path = "M 300 {0} C {2} {0} {2} {1} 300 {1}".format(y1,y2,midx);

                    canvas.append("svg:path")
                    .attr("d",path)
                    .style("stroke-width", widthScaling(scalingFactor))
                    .attr("class", "arc");
                };
            });

            ////////////////////////////////////////////////////////////////////
            // CREATE INSET ////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            for (var i=0;i<partitions.length-1;i++){
                var last_prev = partitions[i][0];
                var first_next = partitions[i+1][partitions[i+1].length-1];
                var bars = d3.selectAll('#bars');
                var last_bar;
                var next_bar;
                bars.each(function(i) {
                    if (i.name == last_prev.name){
                        last_bar = d3.select(this);
                    }
                    if (i.name == first_next.name){
                        next_bar = d3.select(this);
                    }
                });
                var offset_last = parseFloat(last_prev["height_offset"]);
                var offset_next = parseFloat(first_next["height_offset"]);

                // start point
                var x1 = next_bar.attr("x");
                var y1 = next_bar.attr("y") + offset_next;

                console.log("offset last is" + offset_last);
                console.log("offset next is" + offset_next);

                //end point
                var x2 = last_bar.attr("x");
                var y2 = last_bar.attr("y") + offset_last;

                // control point 1
                var cx = next_bar.attr("x");
                var cy = next_bar.attr("y")-graphSpacing + 25 + offset_next;

                var cx1 = last_bar.attr("x") + 100;
                var cy2 = last_bar.attr("y") + offset_last;

                var path = "M {0},{1} C {2},{3} {4},{5} {6},{7}".format(x1,y1,cx,cy,cx1,cy2,x2,y2);

                console.log(y1);
                console.log(y2);
                canvas.append("svg:path")
                .attr("d",path)
                .style("stroke-width", 10)
                .attr("class", "arc");

                console.log(path);

            }

        });
    </script>
</body>
</html>
