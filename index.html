<!DOCTYPE html>
<html>
<head>
    <title>3300 - P1</title>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    <style>
        body, html, svg {
            margin: 0;
            padding: 0;
        }
        #xaxis .domain {
            fill:none;
        }
        body, #myBtn {
            font-family: "Roboto Slab", serif;
            font-weight: 400;
            fill: #E0E0E0;
            color: #E0E0E0;
            font-size: 12pt;
            background: #2B303B;
        }
        #title {
            font-weight: 900;
            font-size: 20pt;
            margin-left: 300px;
            margin-top: 20px;
        }
        .x.axis {
            font-size: 10pt;
        }
        .sub.axis {
            font-size: 10pt;
            fill: #878787;
            font-family: "Roboto";
            font-size: 10pt;
            font-weight: 300;
        }
        .axis path {
            fill: none;
        }
        rect {
            rx: 3;
            ry: 3;
        }
        .arc {
            fill: none;
            stroke: #E0E0E0;
            opacity: .3;
        }
        #footer {
            text-align: center;
        }
        #footer i {
            font-size: 75%;
        }
        #footer a, #footer a:hover, #footer a:visited, #footer p {
            color: #E0E0E0;
            font-weight: 300;
        }

        #myBtn {
            fill: none;
            background: none;
            border: none;
            outline: none;
            text-decoration: underline;
            font-weight:300;
        }

        /* The Modal (background) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
        }

        /* Modal Content/Box */
        .modal-content {
            background: rgba(30,33,43, .9);
            margin: 50px auto; /* 15% from the top and centered */
            padding: 20px;
            width: 500px;
            color: #E0E0E0;
        }
        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #sourceTable a {
            color: #E0E0E0;
        }
        #sourceTable th {
            padding-bottom: 10px;
        }
/*         .zip {
            fill: linear-gradient(right, rgba(255,0,0,0), rgba(255,0,0,1));
        } */
        #legend {
            position: absolute;
            top: 100px;
            left: 1000px;
            font-size: 22px;
        }

    </style>
    <link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet">

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script>
            // First, checks if it isn't implemented yet.
            if (!String.prototype.format) {
              String.prototype.format = function() {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function(match, number) {
                  return typeof args[number] != 'undefined'
                  ? args[number]
                  : match
                  ;
              });
            };
        }
    </script>

</head>
<body>
    <div id="title">Scale of the U.S. National Debt</div>
    <div id="wrapper"></div>
    <script>

        var categories;
        d3.csv("data.csv", function(data) {

            // console.log(data);

            ////////////////////////////////////////////////////////////////////
            // CONSTANTS ///////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            // bars
            var BarHeight = 50;
            var BarSpacing = 5;

            // padding / spacing
            var paddingLeft = 300;
            var paddingRight = paddingLeft / 3;
            var paddingTop = BarHeight;
            var paddingBottom = 0;
            var graphSpacing = BarHeight * 2;

            // titles
            var titleOffset = -10;
            var subtitleOffset = 10;

            // scales / colors
            var scales = [1000, 1000000, 1000000000, 1000000000000];
            var colors = ['#bf616a', '#d08770', '#ebcb8b', '#a3be8c', '#796895', '#5C7DA4', '#b48ead', '#ab7967', '#537776'];

            categories = [];
            for (var i = 0; i < data.length; i++) {
                if (categories.indexOf(data[i]['category']) === -1)
                    categories.push(data[i]['category']);
            }

            // console.log(categories.length);

            // canvas geometry
            var width = 1200;
            if (window.innerWidth < 1200) {
                width = 1200;
            }
            else if (window.innerWidth > 2000) {
                width = 2000;
            }
            else {
                width = window.innerWidth;
            }
            var height = data.length * (BarHeight + BarSpacing) + (graphSpacing * scales.length) + 400;
            var cur_height = 0;
            var canvas = d3.select('#wrapper')
            .append('svg')
            .attr("id","main")
            .attr({'width': width,'height': height});

            ////////////////////////////////////////////////////////////////////
            // DRAW INSETS /////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            function drawGraph(data, xmax) {

                ////////////////////////////////////////////////////////////////
                // CONSTANTS ///////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                var xmin = 0;
                var height = data.length * (BarHeight + BarSpacing) + graphSpacing;

                var canvas = d3.select('#wrapper')
                .select('#main')
                .append("g")
                .attr("transform", "translate(0," + cur_height + ")")
                .attr('class', 'inset');

                var tickVals = [0];
                for (var i = 0; i <= 10; i++) {
                    tickVals.push((xmax / 10) * i);
                }

                ////////////////////////////////////////////////////////////////
                // SCALES //////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                var xscale = d3.scale.linear()
                .domain([xmin, xmax])
                .range([0, width - (paddingLeft + paddingRight)]);

                var yscale = d3.scale.linear()
                .domain([0,data.length - 1])
                .range([height - paddingBottom, paddingTop]);

                ////////////////////////////////////////////////////////////////
                // AXES ////////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                // X axis
                var formatValue = d3.format("$s");
                var xAxis = d3.svg.axis()
                .orient('bottom')
                .scale(xscale)
                .tickValues(tickVals)
                .tickFormat(function(d) {
                    if (width > 1600) {
                        return formatValue(d)
                        .replace('k', ' thousand')
                        .replace('M', ' million')
                        .replace('G', ' billion')
                        .replace('T', ' trillion');
                    }
                    else {
                        return formatValue(d)
                        .replace('k', ' k')
                        .replace('M', ' M')
                        .replace('G', ' B')
                        .replace('T', ' T');
                    }
                });

                // Y axis
                var yAxis = d3.svg.axis()
                .orient('left')
                .scale(yscale)
                .tickFormat(function(d,i){
                    return data[i].name;
                })
                .tickValues(d3.range(data.length));

                var subyAxis = d3.svg.axis()
                .orient('left')
                .scale(yscale)
                .tickFormat(function(d,i){
                    try {
                        return data[i].subtitle;
                    } catch(e) {}
                })
                .tickValues(d3.range(data.length));

                // Create axes
                canvas.append("g")
                .attr("transform", "translate(" + paddingLeft +"," + (height - paddingBottom + (BarHeight / 1.5)) + ")")
                .attr("class", "x axis").call(xAxis);
                canvas.append("g")
                .attr("transform", "translate(" + (paddingLeft - 10) + "," + titleOffset + ")")
                .attr("class", "y axis").call(yAxis);
                canvas.append("g")
                .attr("transform", "translate(" + (paddingLeft - 10) + ","+ subtitleOffset +")")
                .attr("class", "y sub axis").call(subyAxis);

                ////////////////////////////////////////////////////////////////
                // BARS ////////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                var chart = canvas
                .selectAll('rect')
                .data(data)
                .enter()
                .append('rect')
                .datum(function (d){
                    d["height_offset"] = cur_height;
                    return d; })
                .attr('id','bars')
                .attr('height', BarHeight)
                .attr({
                    'x': paddingLeft,
                    'width': function(d) {
                        return xscale(parseFloat(d.price));
                    },
                    'y': function(d,i) {
                        return yscale(i) - (BarHeight / 2);
                    }
                })
                .style({
                    'fill': function(d, i) {
                        var i = categories.indexOf(data[i]['category']);
                        return colors[i];
                    }
                });

                ////////////////////////////////////////////////////////////////
                // SLICES //////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////

                function slice(xmax, partitions,width){
                    for (var i = 1; i < partitions; i++){
                        canvas.append('rect')
                        .attr({
                            'x': xscale((xmax / partitions) * i) + paddingLeft,
                            'width': width,
                            'y': 0,
                            'height': height + 30
                        })
                        .style('fill', '#2B303B')
                    }
                }
                slice(xmax, 10, 2);
                slice(xmax, 100, 0.5);

                cur_height += height + graphSpacing;
            }

            var legend = d3.select('#wrapper')
            .append('svg')
            .attr("id","legend")
            .attr({'width': 250,'height': 250})
            .append('g')
            .selectAll('text')
            .data(categories)
            .enter()
            .append('text')
            .attr({
                'x': 0,
                'y': function(d, i) {
                    return i * 30;
                },
                'id': 'legend'
            })
            .text(function(d) {
                return d;
            })
            .style({
                'fill': function(d, i) {
                    var i = categories.indexOf(d);
                    return colors[i];
                }
            });
            ////////////////////////////////////////////////////////////////////
            // CREATE PARTITIONS ///////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            var cur = 0;
            var i = 0;

            var partitions = new Array();
            partitions.push(new Array());
            data.forEach(function(point) {
                if (point.price <= scales[cur]) {
                    partitions[i].push(point);
                }
                else {
                    drawGraph(partitions[i].reverse(),scales[cur]);
                    i++;
                    partitions.push(new Array());
                    partitions[i].push(point);
                    cur++;
                }
            });
            drawGraph(partitions[i].reverse(),scales[cur]);

            ////////////////////////////////////////////////////////////////////
            // CREATE LINKS ////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            var linkingGroups = {};
            var bars = d3.selectAll('#bars');
            bars.each(function(i) {
                if (i['Linking']){
                    var offset_h = parseFloat(i["height_offset"]);
                    var y = parseFloat(d3.select(this).attr("y"));
                    var price = parseFloat(i['price']);
                    if (linkingGroups[i['Linking']]){
                        linkingGroups[i['Linking']].unshift({"y":offset_h+y,"price":price});
                    }
                    else{
                        linkingGroups[i['Linking']] = [{"y":offset_h+y,"price":price}];
                    }
                }
            });

            var curveMax = 800;

            // draw a curve path for each linking
            Object.keys(linkingGroups).forEach(function (d,i){
                pathinfo = [];
                linkingGroups[d].forEach(function (val,i){
                    pathinfo.push(val["y"]);
                });

                priceinfo = [];
                linkingGroups[d].forEach(function (val,i){
                    priceinfo.push(val["price"]);
                });

                pathinfo.sort();
                priceinfo.sort();

                var baryMidpoint = BarHeight/2;

                var xCurveScaling = d3.scale.linear()
                .domain([0, curveMax])
                .range([paddingLeft, width - paddingRight]);

                var widthScaling = d3.scale.linear()
                .domain([0, curveMax])
                .range([5, 40]);

                for (var i=0;i<pathinfo.length-1;i++){
                    var y1 = pathinfo[i]+baryMidpoint;
                    var y2 = pathinfo[i+1]+baryMidpoint;
                    var midy = (y1+y2)/2;
                    var scalingFactor = midy - Math.min(y1,y2);
                    var midx = xCurveScaling(scalingFactor);
                    var path = "M 300 {0} C {2} {0} {2} {1} 300 {1}".format(y1,y2,midx);

                    var pricediff = Math.abs(priceinfo[i+1] - priceinfo[i]);
                    var minprice = Math.min(priceinfo[i+1],priceinfo[i]);
                    var maxprice = Math.min(priceinfo[i+1],priceinfo[i]);

                    var proportion = Math.trunc(pricediff/minprice * 100);

                    var textProportion = proportion + "%";

                    canvas.append("text")
                    .text(textProportion)
                    .attr("x",midx)
                    .attr("y",midy)
                    .style("fill", "white");

                    canvas.append("svg:path")
                    .attr("d",path)
                    .style("stroke-width", widthScaling(scalingFactor))
                    .attr("class", "arc");
                };
            });

            ////////////////////////////////////////////////////////////////////
            // CREATE INSET ////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            var gradient = canvas.append("defs")
            .append("linearGradient")
            .attr("id", "gradient")
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "0%")
            .attr("y2", "100%")
            .attr("spreadMethod", "pad");

            gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#839DCF")
            .attr("stop-opacity", 0);

            gradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#839DCF")
            .attr("stop-opacity", .5);

            var path = "M 300,775 C 300,705 "+ width + ",705 "+ width + ",705 L 300,705 Z";
            canvas.append("svg:path")
            .attr("d",path)
            .style("stroke-width", 10)
            .attr("class","zip")
            .attr("fill", "url(#gradient)")

            var path = "M 300,775 C 300,705 "+ width + ",705 "+ width + ",705 L 300,705 Z";
            canvas.append("svg:path")
            .attr("d",path)
            .style("stroke-width", 10)
            .attr("class","zip")
            .attr("fill", "url(#gradient)")
            .attr("transform","translate(0,1720)");


            var path = "M 300,775 C 300,705 "+ width + ",705 "+ width + ",705 L 300,705 Z";
            canvas.append("svg:path")
            .attr("d",path)
            .style("stroke-width", 10)
            .attr("class","zip")
            .attr("fill", "url(#gradient)")
            .attr("transform","translate(0,915)");

            var sources = document.getElementById('sourceTable');

            var table = "";
            table += "<tr><th>Item Name</th><th>Source</th></tr>";

            data.forEach(function(data) {
                if (data['name']) {
                    table += "<tr>";
                    table += "<td>" + data['name'] + "</td>";
                    table += "<td><a target='blank' href='" + data['source1'] + "'>Source</a></td>";
                    table += "</tr>";
                }
            });

            sources.innerHTML = table;
        });
    </script>

    <div id="footer">
        <!-- Trigger/Open The Modal -->
        <button id="myBtn">Data Sources</button>

        <p>
            <a href="https://github.com/kevinschaich/us_debt" target="_blank">Made with <i class="em em-heart"></i> at Cornell</a>
        </p>
        <p>
            Inspired by <a href="http://www.informationisbeautiful.net/visualizations/million-lines-of-code/" target="_blank">Million Lines of Code</a>
        </p>
    </div>

    <!-- Modal -->
    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">x</span>
            <table id="sourceTable" align="center"></table>
        </div>

    </div>

    <script>
        // Get the modal
        var modal = document.getElementById('myModal');

        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on the button, open the modal
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>
